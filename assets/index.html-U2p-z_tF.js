import{_ as i,c as a,a as n,o as l}from"./app-BYecpAAQ.js";const h={};function e(t,s){return l(),a("div",null,s[0]||(s[0]=[n(`<p>笔者在重写自己的操作系统内核，在这个过程中，我发现通过<code>MBR + Loader + Kernel</code>的三段式启动非常不方便，而且完全不好移植，因此，笔者前去了解了一下现代操作系统的启动流程。</p><blockquote><p>注意，本文代码部分进行了一定的简化，省略了错误处理和参数检查流程，详细请参考<a href="https://github.com/Dessera/OrdOS" target="_blank" rel="noopener noreferrer">OrdOS</a>，截至本文完成，所有的代码均托管于<code>ordos/v2</code>分支。</p></blockquote><h2 id="loader" tabindex="-1"><a class="header-anchor" href="#loader"><span>Loader</span></a></h2><p>我们都知道，传统操作系统中，需要使用 Loader 作为踏板来启动操作系统，Loader 的作用可以分为以下两个部分：</p><ul><li>按照<code>elf</code>段加载内核</li><li>进行一些平台特定的设置（比如打开A20端口等）</li></ul><p>在我们编写的轻量内核中，这部分往往是我们自己编写的，但在现代操作系统中，往往有一个功能更强大的“Generic Loader”，想要实现通用的启动流程，就必须要有通用的协议来规定加载时的细则，上位机开发中，这个协议一般是 Multiboot2 。</p><h2 id="multiboot2" tabindex="-1"><a class="header-anchor" href="#multiboot2"><span>Multiboot2</span></a></h2><p>Multiboot2 是现代操作系统通用的启动协议，常见的 Loader 均支持该协议（例如GRUB2），其大致约定如下内容：</p><ul><li>操作系统镜像的前<code>32768</code>字节内，必须包含 Multiboot2 头结构，其内存结构以<code>8</code>字节对齐</li><li>Multiboot2 会传递初始化数据帮助内核进行初始化</li><li>MUltiboot2 会负责一些架构层次的初始化</li></ul><h3 id="multiboot2-header" tabindex="-1"><a class="header-anchor" href="#multiboot2-header"><span>Multiboot2 Header</span></a></h3><p>Multiboot2 Header 是根据<code>tags</code>组织的变长结构，其包括一个头部和若干个<code>tag</code>节点，这里只列出其中比较主要的部分：</p><ul><li><p>头部：</p><table><thead><tr><th>位置（字节）</th><th>类型</th><th>名称</th><th>描述</th></tr></thead><tbody><tr><td>0</td><td><code>u32</code></td><td>magic</td><td><code>0xE85250D6</code></td></tr><tr><td>4</td><td><code>u32</code></td><td>architecture</td><td>架构代码，<code>i386</code>为<code>0</code></td></tr><tr><td>8</td><td><code>u32</code></td><td>header_length</td><td>头部长度，包括所有<code>tag</code></td></tr><tr><td>12</td><td><code>u32</code></td><td>checksum</td><td><code>-(magic + architecture + header_length)</code></td></tr></tbody></table></li><li><p>EFI32 入口：</p><table><thead><tr><th>位置（字节）</th><th>类型</th><th>名称</th><th>描述</th></tr></thead><tbody><tr><td>0</td><td><code>u16</code></td><td>type</td><td><code>8</code></td></tr><tr><td>2</td><td><code>u16</code></td><td>flags</td><td><code>tag</code>的额外属性</td></tr><tr><td>4</td><td><code>u32</code></td><td>size</td><td>该<code>tag</code>的长度</td></tr><tr><td>8</td><td><code>u32</code></td><td>entry_addr</td><td>入口地址</td></tr></tbody></table></li><li><p>通用入口（除 EFI 外）：</p><table><thead><tr><th>位置（字节）</th><th>类型</th><th>名称</th><th>描述</th></tr></thead><tbody><tr><td>0</td><td><code>u16</code></td><td>type</td><td><code>3</code></td></tr><tr><td>2</td><td><code>u16</code></td><td>flags</td><td><code>tag</code>的额外属性</td></tr><tr><td>4</td><td><code>u32</code></td><td>size</td><td>该<code>tag</code>的长度</td></tr><tr><td>8</td><td><code>u32</code></td><td>entry_addr</td><td>入口地址</td></tr></tbody></table></li></ul><blockquote><p>在 EFI 启动下，后者会被忽略，但在传统 BIOS 启动时，前者会报错（error: unsupported tag: 0x08），我们需要指定<code>flags</code>最低位为1,含义为该<code>tag</code>可选。</p></blockquote><p>我们根据上表构建启动头：</p><div class="language-asm line-numbers-mode" data-highlighter="shiki" data-ext="asm" style="--shiki-dark:#abb2bf;--shiki-light:#383A42;--shiki-dark-bg:#282c34;--shiki-light-bg:#FAFAFA;"><pre class="shiki shiki-themes one-dark-pro one-light vp-code"><code class="language-asm"><span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">// multiboot.S</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;">section .text</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">.init, &quot;</span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;">ax</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  .globl _start</span></span>
<span class="line"><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;">_start:</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  // start logic</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;">section .rodata</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">.init.multiboot, &quot;a&quot;</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  MULTIBOOT_HEADER(_multiboot_header, MULTIBOOT_HEADER_ARCH_1386)</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">    MULTIBOOT_HEADER_TAG_EFI32_ENTRY(_multiboot_efi32_entry, _start)</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">    MULTIBOOT_HEADER_TAG_BIOS_ENTRY(_multiboot_bios_entry, _start)</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">    MULTIBOOT_HEADER_TAG_END(_multiboot_end)</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  MULTIBOOT_HEADER_END(_multiboot_header)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>头文件：</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-dark:#abb2bf;--shiki-light:#383A42;--shiki-dark-bg:#282c34;--shiki-light-bg:#FAFAFA;"><pre class="shiki shiki-themes one-dark-pro one-light vp-code"><code class="language-c"><span class="line"><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#A0A1A7;--shiki-light-font-style:italic;">// multiboot.h</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">#pragma</span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;"> once</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">#define</span><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;"> MULTIBOOT_HEADER_MAGIC</span><span style="--shiki-dark:#E06C75;--shiki-light:#986801;"> 0x</span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;">E85250D6</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">#define</span><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;"> MULTIBOOT_HEADER_ARCH_1386</span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;"> 0</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">#define</span><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;"> MULTIBOOT_HEADER_TAG_TYPE_END</span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;"> 0</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">#define</span><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;"> MULTIBOOT_HEADER_TAG_TYPE_ENTRY_ADDRESS</span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;"> 3</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">#define</span><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;"> MULTIBOOT_HEADER_TAG_TYPE_ENTRY_ADDRESS_EFI32</span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;"> 8</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">#define</span><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;"> MULTIBOOT_HEADER_TAG_FLAG_OPTIONAL</span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;"> 1</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">#define</span><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;"> MULTIBOOT_HEADER</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#E06C75;--shiki-dark-font-style:italic;--shiki-light:#383A42;--shiki-light-font-style:inherit;">name</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">, </span><span style="--shiki-dark:#E06C75;--shiki-dark-font-style:italic;--shiki-light:#383A42;--shiki-light-font-style:inherit;">isa</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">)                                            </span><span style="--shiki-dark:#56B6C2;--shiki-light:#0184BC;">\\</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  name:                                                                        </span><span style="--shiki-dark:#56B6C2;--shiki-light:#0184BC;">\\</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  .align </span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;">8</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">;                                                                    </span><span style="--shiki-dark:#56B6C2;--shiki-light:#0184BC;">\\</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  .</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">long</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> MULTIBOOT_HEADER_MAGIC;                                                </span><span style="--shiki-dark:#56B6C2;--shiki-light:#0184BC;">\\</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  .</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">long</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> isa;                                                                   </span><span style="--shiki-dark:#56B6C2;--shiki-light:#0184BC;">\\</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  .</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">long</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> name##_end </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">-</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> name;                                                     </span><span style="--shiki-dark:#56B6C2;--shiki-light:#0184BC;">\\</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  .</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">long</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;"> -</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> (MULTIBOOT_HEADER_MAGIC </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">+</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> isa </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">+</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> name##_end </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">-</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> name);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">#define</span><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;"> MULTIBOOT_HEADER_END</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#E06C75;--shiki-dark-font-style:italic;--shiki-light:#383A42;--shiki-light-font-style:inherit;">name</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">) name##_end:</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">#define</span><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;"> MULTIBOOT_HEADER_TAG_EFI32_ENTRY</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#E06C75;--shiki-dark-font-style:italic;--shiki-light:#383A42;--shiki-light-font-style:inherit;">name</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">, </span><span style="--shiki-dark:#E06C75;--shiki-dark-font-style:italic;--shiki-light:#383A42;--shiki-light-font-style:inherit;">addr</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">)                           </span><span style="--shiki-dark:#56B6C2;--shiki-light:#0184BC;">\\</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  name:                                                                        </span><span style="--shiki-dark:#56B6C2;--shiki-light:#0184BC;">\\</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  .align </span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;">8</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">;                                                                    </span><span style="--shiki-dark:#56B6C2;--shiki-light:#0184BC;">\\</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  .</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">short</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> MULTIBOOT_HEADER_TAG_TYPE_ENTRY_ADDRESS_EFI32;                        </span><span style="--shiki-dark:#56B6C2;--shiki-light:#0184BC;">\\</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  .</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">short</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> MULTIBOOT_HEADER_TAG_FLAG_OPTIONAL;                                   </span><span style="--shiki-dark:#56B6C2;--shiki-light:#0184BC;">\\</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  .</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">long</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> name##_end </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">-</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> name;                                                     </span><span style="--shiki-dark:#56B6C2;--shiki-light:#0184BC;">\\</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  .</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">long</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> addr;                                                                  </span><span style="--shiki-dark:#56B6C2;--shiki-light:#0184BC;">\\</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  name##_end:</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">#define</span><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;"> MULTIBOOT_HEADER_TAG_BIOS_ENTRY</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#E06C75;--shiki-dark-font-style:italic;--shiki-light:#383A42;--shiki-light-font-style:inherit;">name</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">, </span><span style="--shiki-dark:#E06C75;--shiki-dark-font-style:italic;--shiki-light:#383A42;--shiki-light-font-style:inherit;">addr</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">)                            </span><span style="--shiki-dark:#56B6C2;--shiki-light:#0184BC;">\\</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  name:                                                                        </span><span style="--shiki-dark:#56B6C2;--shiki-light:#0184BC;">\\</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  .align </span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;">8</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">;                                                                    </span><span style="--shiki-dark:#56B6C2;--shiki-light:#0184BC;">\\</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  .</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">short</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> MULTIBOOT_HEADER_TAG_TYPE_ENTRY_ADDRESS;                              </span><span style="--shiki-dark:#56B6C2;--shiki-light:#0184BC;">\\</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  .</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">short</span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;"> 0</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">;                                                                    </span><span style="--shiki-dark:#56B6C2;--shiki-light:#0184BC;">\\</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  .</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">long</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> name##_end </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">-</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> name;                                                     </span><span style="--shiki-dark:#56B6C2;--shiki-light:#0184BC;">\\</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  .</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">long</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> addr;                                                                  </span><span style="--shiki-dark:#56B6C2;--shiki-light:#0184BC;">\\</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  name##_end:</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">#define</span><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;"> MULTIBOOT_HEADER_TAG_END</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#E06C75;--shiki-dark-font-style:italic;--shiki-light:#383A42;--shiki-light-font-style:inherit;">name</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">)                                         </span><span style="--shiki-dark:#56B6C2;--shiki-light:#0184BC;">\\</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  name:                                                                        </span><span style="--shiki-dark:#56B6C2;--shiki-light:#0184BC;">\\</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  .align </span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;">8</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">;                                                                    </span><span style="--shiki-dark:#56B6C2;--shiki-light:#0184BC;">\\</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  .</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">short</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> MULTIBOOT_HEADER_TAG_TYPE_END;                                        </span><span style="--shiki-dark:#56B6C2;--shiki-light:#0184BC;">\\</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  .</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">short</span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;"> 0</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">;                                                                    </span><span style="--shiki-dark:#56B6C2;--shiki-light:#0184BC;">\\</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  .</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">long</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> name##_end </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">-</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> name;                                                     </span><span style="--shiki-dark:#56B6C2;--shiki-light:#0184BC;">\\</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  name##_end:</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们也可以不指定入口<code>tag</code>,因为在没有入口<code>tag</code>的情况下，Loader 会直接跳转到我们内核的最开始：</p><div class="language-asm line-numbers-mode" data-highlighter="shiki" data-ext="asm" style="--shiki-dark:#abb2bf;--shiki-light:#383A42;--shiki-dark-bg:#282c34;--shiki-light-bg:#FAFAFA;"><pre class="shiki shiki-themes one-dark-pro one-light vp-code"><code class="language-asm"><span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;">section .text</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">.init, &quot;</span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;">ax</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  .globl _start</span></span>
<span class="line"><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;">_start:</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#383A42;">  jmp</span><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;"> multiboot_start:</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;">multiboot_header:</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  MULTIBOOT_HEADER(_multiboot_header, MULTIBOOT_HEADER_ARCH_1386)</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">    MULTIBOOT_HEADER_TAG_END(_multiboot_end)</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  MULTIBOOT_HEADER_END(_multiboot_header)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;">multiboot_start:</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  // start logic</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>刚刚提到，Multiboot2 在架构层面做了初始化工作，在<code>i386</code>上，这个时候我们已经打开了 A20 地址线，除此之外，<code>eax</code>和<code>ebx</code>会被放入特殊的值：</p><ul><li><code>eax</code>：<code>0x36D76289</code>魔数</li><li><code>ebx</code>：一个变长结构，以<code>tags</code>的形式组织初始化信息</li></ul><h2 id="kernel-prelude" tabindex="-1"><a class="header-anchor" href="#kernel-prelude"><span>Kernel Prelude</span></a></h2><p>在进入内核后，要处理以下问题：</p><ul><li>切换到新的函数栈</li><li>清空<code>eflags</code></li><li>解析 Multiboot2 参数</li></ul><p>因为我们还没有初始化内存子系统，这个时候想要分配内存是极为困难的，所以我们习惯临时在数据段中申请一块内存来当作函数栈：</p><div class="language-asm line-numbers-mode" data-highlighter="shiki" data-ext="asm" style="--shiki-dark:#abb2bf;--shiki-light:#383A42;--shiki-dark-bg:#282c34;--shiki-light-bg:#FAFAFA;"><pre class="shiki shiki-themes one-dark-pro one-light vp-code"><code class="language-asm"><span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;">section .bss</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">.init, &quot;wa&quot;</span></span>
<span class="line"><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;">_boot_stack:</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  .zero ORDOS_INIT_STACKSIZE</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后，在<code>_start</code>中首先加载栈：</p><div class="language-asm line-numbers-mode" data-highlighter="shiki" data-ext="asm" style="--shiki-dark:#abb2bf;--shiki-light:#383A42;--shiki-dark-bg:#282c34;--shiki-light-bg:#FAFAFA;"><pre class="shiki shiki-themes one-dark-pro one-light vp-code"><code class="language-asm"><span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">movl $(_boot_stack + ORDOS_INIT_STACKSIZE), %</span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;">esp</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><blockquote><p>这里，<code>ORDOS_INIT_STACKSIZE</code>的大小是<code>0x1000</code> 也就是<code>4kb</code>。</p></blockquote><p>然后，我们清除<code>eflags</code>：</p><div class="language-asm line-numbers-mode" data-highlighter="shiki" data-ext="asm" style="--shiki-dark:#abb2bf;--shiki-light:#383A42;--shiki-dark-bg:#282c34;--shiki-light-bg:#FAFAFA;"><pre class="shiki shiki-themes one-dark-pro one-light vp-code"><code class="language-asm"><span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">pushl </span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;">$0</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#383A42;">popf</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>鉴于 Multiboot2 的<code>tags</code>比较难以解析，笔者建议使用C语言进行处理，在汇编侧进行调用：</p><div class="language-asm line-numbers-mode" data-highlighter="shiki" data-ext="asm" style="--shiki-dark:#abb2bf;--shiki-light:#383A42;--shiki-dark-bg:#282c34;--shiki-light-bg:#FAFAFA;"><pre class="shiki shiki-themes one-dark-pro one-light vp-code"><code class="language-asm"><span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">pushl %</span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;">ebx</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">pushl %</span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;">eax</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#383A42;">call</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> kprelude</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>C语言函数：</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-dark:#abb2bf;--shiki-light:#383A42;--shiki-dark-bg:#282c34;--shiki-light-bg:#FAFAFA;"><pre class="shiki shiki-themes one-dark-pro one-light vp-code"><code class="language-c"><span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">__asm_linkage __prelude </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">void</span></span>
<span class="line"><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;">kprelude</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#E06C75;--shiki-light:#383A42;">u32 </span><span style="--shiki-dark:#E06C75;--shiki-dark-font-style:italic;--shiki-light:#383A42;--shiki-light-font-style:inherit;">magic</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">,</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;"> void*</span><span style="--shiki-dark:#E06C75;--shiki-dark-font-style:italic;--shiki-light:#383A42;--shiki-light-font-style:inherit;"> info</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>我们的<code>kprelude</code>的工作也可以分为两部分：</p><ul><li>解析<code>multiboot2</code>的<code>tags</code>，并传递给内核（作为初始化参数）</li><li>初始化早期内存管理</li></ul><h3 id="调用链分析" tabindex="-1"><a class="header-anchor" href="#调用链分析"><span>调用链分析</span></a></h3><p>对于 Multiboot2 的<code>tags</code>，必须要声明的是，它和我们刚刚定义的头部<code>tags</code>完全不是一回事，现在我们要解析的<code>tags</code>是 Multiboot2 为我们获取的系统信息，其中比较重要的有<strong>内存信息</strong>和<strong>启动参数</strong>两部分。</p><p>因为正式进入内核需要我们加载内核虚拟空间，因此我们需要在 Prelude 阶段初始化一部分内存子系统来完成对页表的申请，基于以上需求，<code>kprelude</code>调用链可以简化为如下形式：</p><div class="language-plaintext line-numbers-mode" data-highlighter="shiki" data-ext="plaintext" style="--shiki-dark:#abb2bf;--shiki-light:#383A42;--shiki-dark-bg:#282c34;--shiki-light-bg:#FAFAFA;"><pre class="shiki shiki-themes one-dark-pro one-light vp-code"><code class="language-plaintext"><span class="line"><span>kprelude                # 初始化入口</span></span>
<span class="line"><span>  init_from_multiboot   # 解析 Multiboot2 Tags</span></span>
<span class="line"><span>    init_mmap           # 初始化内存信息</span></span>
<span class="line"><span>    init_cmdline        # 初始化启动参数</span></span>
<span class="line"><span>  init_mem              # 初始化早期内存管理</span></span>
<span class="line"><span>    init_bootmem        # 初始化自举内存分配器</span></span>
<span class="line"><span>    init_pagetable      # 初始化页表</span></span>
<span class="line"><span>    init_gdt            # 初始化GDT</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="解析-multiboot2-tags" tabindex="-1"><a class="header-anchor" href="#解析-multiboot2-tags"><span>解析 Multiboot2 Tags</span></a></h3><p>Multiboot2 的<code>tag</code>基本都是变长的，但他们都有相同的前置结构：</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-dark:#abb2bf;--shiki-light:#383A42;--shiki-dark-bg:#282c34;--shiki-light-bg:#FAFAFA;"><pre class="shiki shiki-themes one-dark-pro one-light vp-code"><code class="language-c"><span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">struct</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> multiboot_tag</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">{</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  u32 type;</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  u32 size;</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">};</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>也就是说，我们可以先将地址转换为这个通用结构，通过<code>type</code>识别具体类型再进行一次转换，其中我们需要的<code>tags</code>有以下两种：</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-dark:#abb2bf;--shiki-light:#383A42;--shiki-dark-bg:#282c34;--shiki-light-bg:#FAFAFA;"><pre class="shiki shiki-themes one-dark-pro one-light vp-code"><code class="language-c"><span class="line"></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">#define</span><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;"> MULTIBOOT_TAG_TYPE_END</span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;"> 0</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">#define</span><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;"> MULTIBOOT_TAG_TYPE_CMDLINE</span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;"> 1</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">#define</span><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;"> MULTIBOOT_TAG_TYPE_MMAP</span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;"> 6</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">struct</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> multiboot_mmap</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">{</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">  struct</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> multiboot_tag tag;</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  u32 entry_size;</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  u32 entry_version;</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">  struct</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> multiboot_mmap_entry </span><span style="--shiki-dark:#E06C75;--shiki-light:#E45649;">entries</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">[</span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;">0</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">];</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">struct</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> multiboot_cmdline</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">{</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">  struct</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> multiboot_tag tag;</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">  char</span><span style="--shiki-dark:#E06C75;--shiki-light:#E45649;"> string</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">[</span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;">0</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">];</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">};</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里我们用上了零长数组，代表结构体是变长的。</p><p>解析 Multiboot2 传入的指针时，需要注意传入的指针也是有头部的，我们直接略过他：</p><p>对应<code>kprelude</code>部分如下：</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-dark:#abb2bf;--shiki-light:#383A42;--shiki-dark-bg:#282c34;--shiki-light-bg:#FAFAFA;"><pre class="shiki shiki-themes one-dark-pro one-light vp-code"><code class="language-c"><span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">struct</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> init_info</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">*</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> init </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">=</span><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;"> vaccess</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">&amp;</span><span style="--shiki-dark:#E06C75;--shiki-dark-font-style:italic;--shiki-light:#383A42;--shiki-light-font-style:inherit;">__init</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;">__init_from_multiboot</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#E06C75;--shiki-light:#383A42;">init</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">,</span></span>
<span class="line"><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;">                      poffset</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#E06C75;--shiki-light:#383A42;">info</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">,</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;"> sizeof</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">struct</span><span style="--shiki-dark:#E06C75;--shiki-light:#383A42;"> multiboot_info_header</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">)));</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>multiboot_info_header</code>结构：</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-dark:#abb2bf;--shiki-light:#383A42;--shiki-dark-bg:#282c34;--shiki-light-bg:#FAFAFA;"><pre class="shiki shiki-themes one-dark-pro one-light vp-code"><code class="language-c"><span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">struct</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> multiboot_info_header</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">{</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  u32 total_size;</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  u32 reserved;</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">};</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>OrdOS 有对指针进行位移的宏<code>poffset</code>，我们向<code>__init_from_multiboot</code>传参时通过该宏略过了<code>multiboot_info_header</code>，下面是<code>poffset</code>的实现：</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-dark:#abb2bf;--shiki-light:#383A42;--shiki-dark-bg:#282c34;--shiki-light-bg:#FAFAFA;"><pre class="shiki shiki-themes one-dark-pro one-light vp-code"><code class="language-c"><span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">#define</span><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;"> poffset</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#E06C75;--shiki-dark-font-style:italic;--shiki-light:#383A42;--shiki-light-font-style:inherit;">ptr</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">, </span><span style="--shiki-dark:#E06C75;--shiki-dark-font-style:italic;--shiki-light:#383A42;--shiki-light-font-style:inherit;">offs</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">) ((</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">void*</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">)((</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">uintptr_t</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">)(ptr) </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">+</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> (offs)))</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>OrdOS 还有专为初始化设计的结构体<code>__init</code>，因为其位于内核虚拟空间，所以要使用<code>vaccess</code>访问该结构体，<code>vaccess</code>是对<code>poffset</code>的封装：</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-dark:#abb2bf;--shiki-light:#383A42;--shiki-dark-bg:#282c34;--shiki-light-bg:#FAFAFA;"><pre class="shiki shiki-themes one-dark-pro one-light vp-code"><code class="language-c"><span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">#define</span><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;"> vaccess</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#E06C75;--shiki-dark-font-style:italic;--shiki-light:#383A42;--shiki-light-font-style:inherit;">ptr</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">) (</span><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;">poffset</span><span style="--shiki-dark:#E06C75;--shiki-light:#383A42;">(ptr</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">,</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;"> -</span><span style="--shiki-dark:#E06C75;--shiki-light:#383A42;">ORDOS_KERNEL_VADDR)</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><code>ORDOS_KERNEL_VADDR</code>是内核虚拟空间的起始地址，这里是<code>0xC0000000</code>。</p><p>在<code>__init_from_multiboot</code>中，遍历<code>tags</code>：</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-dark:#abb2bf;--shiki-light:#383A42;--shiki-dark-bg:#282c34;--shiki-light-bg:#FAFAFA;"><pre class="shiki shiki-themes one-dark-pro one-light vp-code"><code class="language-c"><span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">__prelude </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">static</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;"> void</span></span>
<span class="line"><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;">__init_from_multiboot</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">struct</span><span style="--shiki-dark:#E06C75;--shiki-light:#383A42;"> init_info</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">*</span><span style="--shiki-dark:#E06C75;--shiki-dark-font-style:italic;--shiki-light:#383A42;--shiki-light-font-style:inherit;"> init</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">,</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;"> void*</span><span style="--shiki-dark:#E06C75;--shiki-dark-font-style:italic;--shiki-light:#383A42;--shiki-light-font-style:inherit;"> tags</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">)</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">{</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">  struct</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> multiboot_mmap</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">*</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> mmap </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">=</span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;"> NULL</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">;</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">  struct</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> multiboot_cmdline</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">*</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> cmdline </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">=</span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;"> NULL</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">  for</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> (</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">struct</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> multiboot_tag</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">*</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> tag </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">=</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> tags; </span><span style="--shiki-dark:#E5C07B;--shiki-light:#E45649;">tag</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">-&gt;</span><span style="--shiki-dark:#E06C75;--shiki-light:#E45649;">type</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;"> !=</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> MULTIBOOT_TAG_TYPE_END;</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">       tag </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">=</span><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;"> poffset</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(tag, </span><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;">align_up</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#E5C07B;--shiki-light:#E45649;">tag</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">-&gt;</span><span style="--shiki-dark:#E06C75;--shiki-light:#E45649;">size</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">, MULTIBOOT_TAG_ALIGN))) {</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">    if</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> (</span><span style="--shiki-dark:#E5C07B;--shiki-light:#E45649;">tag</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">-&gt;</span><span style="--shiki-dark:#E06C75;--shiki-light:#E45649;">type</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;"> ==</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> MULTIBOOT_TAG_TYPE_MMAP) {</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">      mmap </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">=</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> (</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">struct</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> multiboot_mmap</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">*</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">)tag;</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">    if</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> (</span><span style="--shiki-dark:#E5C07B;--shiki-light:#E45649;">tag</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">-&gt;</span><span style="--shiki-dark:#E06C75;--shiki-light:#E45649;">type</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;"> ==</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> MULTIBOOT_TAG_TYPE_CMDLINE) {</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">      cmdline </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">=</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> (</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">struct</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> multiboot_cmdline</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">*</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">)tag;</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">    }</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;">  __init_mmap</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(init, mmap);</span></span>
<span class="line"><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;">  __init_cmdline</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(init, cmdline);</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们遍历<code>tags</code>，直到碰到结束<code>tag</code>，这里必须注意的是，<code>tags</code>也是八字节对齐的，在移位指针的时候必须将<code>size</code>对齐。</p><p>拿到<code>mmap</code>和<code>cmdline</code>之后，我们实际上要做的就是把他们移动到初始化结构体中：</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-dark:#abb2bf;--shiki-light:#383A42;--shiki-dark-bg:#282c34;--shiki-light-bg:#FAFAFA;"><pre class="shiki shiki-themes one-dark-pro one-light vp-code"><code class="language-c"><span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">__prelude </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">static</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;"> void</span></span>
<span class="line"><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;">__init_mmap</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">struct</span><span style="--shiki-dark:#E06C75;--shiki-light:#383A42;"> init_info</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">*</span><span style="--shiki-dark:#E06C75;--shiki-dark-font-style:italic;--shiki-light:#383A42;--shiki-light-font-style:inherit;"> init</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">,</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;"> struct</span><span style="--shiki-dark:#E06C75;--shiki-light:#383A42;"> multiboot_mmap</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">*</span><span style="--shiki-dark:#E06C75;--shiki-dark-font-style:italic;--shiki-light:#383A42;--shiki-light-font-style:inherit;"> mmap</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">)</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">{</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">  for</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> (</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">struct</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> multiboot_mmap_entry</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">*</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> entry </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">=</span><span style="--shiki-dark:#E5C07B;--shiki-light:#E45649;"> mmap</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">-&gt;</span><span style="--shiki-dark:#E06C75;--shiki-light:#E45649;">entries</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">;</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">       (</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">void*</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">)entry </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">&lt;</span><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;"> poffset</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(mmap, </span><span style="--shiki-dark:#E5C07B;--shiki-light:#E45649;">mmap</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">-&gt;</span><span style="--shiki-dark:#E5C07B;--shiki-light:#E45649;">tag</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">.</span><span style="--shiki-dark:#E06C75;--shiki-light:#E45649;">size</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">);</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">       entry </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">=</span><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;"> poffset</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(entry, </span><span style="--shiki-dark:#E5C07B;--shiki-light:#E45649;">mmap</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">-&gt;</span><span style="--shiki-dark:#E06C75;--shiki-light:#E45649;">entry_size</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">)) {</span></span>
<span class="line"><span style="--shiki-dark:#E5C07B;--shiki-light:#E45649;">    init</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">-&gt;</span><span style="--shiki-dark:#E06C75;--shiki-light:#E45649;">mmap</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">[</span><span style="--shiki-dark:#E5C07B;--shiki-light:#E45649;">init</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">-&gt;</span><span style="--shiki-dark:#E06C75;--shiki-light:#E45649;">mmap_cnt</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">].</span><span style="--shiki-dark:#E06C75;--shiki-light:#E45649;">type</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;"> =</span><span style="--shiki-dark:#E5C07B;--shiki-light:#E45649;"> entry</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">-&gt;</span><span style="--shiki-dark:#E06C75;--shiki-light:#E45649;">type</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">;</span></span>
<span class="line"><span style="--shiki-dark:#E5C07B;--shiki-light:#E45649;">    init</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">-&gt;</span><span style="--shiki-dark:#E06C75;--shiki-light:#E45649;">mmap</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">[</span><span style="--shiki-dark:#E5C07B;--shiki-light:#E45649;">init</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">-&gt;</span><span style="--shiki-dark:#E06C75;--shiki-light:#E45649;">mmap_cnt</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">].</span><span style="--shiki-dark:#E06C75;--shiki-light:#E45649;">addr</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;"> =</span><span style="--shiki-dark:#E5C07B;--shiki-light:#E45649;"> entry</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">-&gt;</span><span style="--shiki-dark:#E06C75;--shiki-light:#E45649;">addr</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">;</span></span>
<span class="line"><span style="--shiki-dark:#E5C07B;--shiki-light:#E45649;">    init</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">-&gt;</span><span style="--shiki-dark:#E06C75;--shiki-light:#E45649;">mmap</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">[</span><span style="--shiki-dark:#E5C07B;--shiki-light:#E45649;">init</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">-&gt;</span><span style="--shiki-dark:#E06C75;--shiki-light:#E45649;">mmap_cnt</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">].</span><span style="--shiki-dark:#E06C75;--shiki-light:#E45649;">len</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;"> =</span><span style="--shiki-dark:#E5C07B;--shiki-light:#E45649;"> entry</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">-&gt;</span><span style="--shiki-dark:#E06C75;--shiki-light:#E45649;">len</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">;</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">    ++</span><span style="--shiki-dark:#E5C07B;--shiki-light:#E45649;">init</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">-&gt;</span><span style="--shiki-dark:#E06C75;--shiki-light:#E45649;">mmap_cnt</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">;</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  }</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">__prelude </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">static</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;"> void</span></span>
<span class="line"><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;">__init_cmdline</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">struct</span><span style="--shiki-dark:#E06C75;--shiki-light:#383A42;"> init_info</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">*</span><span style="--shiki-dark:#E06C75;--shiki-dark-font-style:italic;--shiki-light:#383A42;--shiki-light-font-style:inherit;"> init</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">,</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;"> struct</span><span style="--shiki-dark:#E06C75;--shiki-light:#383A42;"> multiboot_cmdline</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">*</span><span style="--shiki-dark:#E06C75;--shiki-dark-font-style:italic;--shiki-light:#383A42;--shiki-light-font-style:inherit;"> cmdline</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">)</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">{</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">  char*</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> src </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">=</span><span style="--shiki-dark:#E5C07B;--shiki-light:#E45649;"> cmdline</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">-&gt;</span><span style="--shiki-dark:#E06C75;--shiki-light:#E45649;">string</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">;</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">  char*</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> dest </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">=</span><span style="--shiki-dark:#E5C07B;--shiki-light:#E45649;"> init</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">-&gt;</span><span style="--shiki-dark:#E06C75;--shiki-light:#E45649;">cmdline</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">;</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">  size_t</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> size </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">=</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> ORDOS_INIT_ARGS_BUFSIZE;</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">  while</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> (size</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">--</span><span style="--shiki-dark:#56B6C2;--shiki-light:#A626A4;"> &amp;&amp;</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> (</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">*</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">dest</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">++</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;"> =</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;"> *</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">src</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">++</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">)) {</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  }</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从<code>multiboot_mmap_entry</code>到<code>__init</code>中的<code>mmap_entry</code>是完全没有变化的，他们的结构如下：</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-dark:#abb2bf;--shiki-light:#383A42;--shiki-dark-bg:#282c34;--shiki-light-bg:#FAFAFA;"><pre class="shiki shiki-themes one-dark-pro one-light vp-code"><code class="language-c"><span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">struct</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> multiboot_mmap_entry</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">{</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  u64 addr;</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  u64 len;</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  u64 type;</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">};</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="初始化内存" tabindex="-1"><a class="header-anchor" href="#初始化内存"><span>初始化内存</span></a></h3><p>内存初始化依赖内存信息，我们的自举分配器实际上就是维护了两个内存指针，我们初始化内存就是将内核的终点和内存区域的终点分别赋值给自举分配器：</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-dark:#abb2bf;--shiki-light:#383A42;--shiki-dark-bg:#282c34;--shiki-light-bg:#FAFAFA;"><pre class="shiki shiki-themes one-dark-pro one-light vp-code"><code class="language-c"><span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">void</span></span>
<span class="line"><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;">bootmem_init</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">void</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">)</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">{</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">  struct</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> init_info</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">*</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> init </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">=</span><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;"> vaccess</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">&amp;</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">__init);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  __bootmem_start </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">=</span><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;"> compiler_kernel_end_paddr</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">  for</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> (</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">size_t</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> i </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">=</span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;"> 0</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">; i </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">&lt;</span><span style="--shiki-dark:#E5C07B;--shiki-light:#E45649;"> init</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">-&gt;</span><span style="--shiki-dark:#E06C75;--shiki-light:#E45649;">mmap_cnt</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">; </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">++</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">i) {</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">    if</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> (</span><span style="--shiki-dark:#E5C07B;--shiki-light:#E45649;">init</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">-&gt;</span><span style="--shiki-dark:#E06C75;--shiki-light:#E45649;">mmap</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">[i].</span><span style="--shiki-dark:#E06C75;--shiki-light:#E45649;">type</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;"> !=</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> PMEM_AVAILABLE) {</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">      continue</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">;</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">    u64 memsize </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">=</span><span style="--shiki-dark:#E5C07B;--shiki-light:#E45649;"> init</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">-&gt;</span><span style="--shiki-dark:#E06C75;--shiki-light:#E45649;">mmap</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">[i].</span><span style="--shiki-dark:#E06C75;--shiki-light:#E45649;">addr</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;"> +</span><span style="--shiki-dark:#E5C07B;--shiki-light:#E45649;"> init</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">-&gt;</span><span style="--shiki-dark:#E06C75;--shiki-light:#E45649;">mmap</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">[i].</span><span style="--shiki-dark:#E06C75;--shiki-light:#E45649;">len</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">;</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">    if</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> (memsize </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">&gt;</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> __bootmem_end) {</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">      __bootmem_end </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">=</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> memsize;</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">    }</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  }</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>每分配一块内存，指针就上移相应的大小：</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-dark:#abb2bf;--shiki-light:#383A42;--shiki-dark-bg:#282c34;--shiki-light-bg:#FAFAFA;"><pre class="shiki shiki-themes one-dark-pro one-light vp-code"><code class="language-c"><span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">void*</span></span>
<span class="line"><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;">bootmem_alloc</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">size_t</span><span style="--shiki-dark:#E06C75;--shiki-dark-font-style:italic;--shiki-light:#383A42;--shiki-light-font-style:inherit;"> size</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">)</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">{</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">  uintptr_t</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> base </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">=</span><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;"> align_up</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(__bootmem_start, size);</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  __bootmem_start </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">=</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> base </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">+</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> size;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">  return</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> (</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">void*</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">)base;</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>拥有分配内存的能力后，就可以着手初始化页表了，我们映射所有的 NORMAL 内存到内核虚拟地址和<code>0</code>地址（为了保证 Prelude 正常运行）：</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-dark:#abb2bf;--shiki-light:#383A42;--shiki-dark-bg:#282c34;--shiki-light-bg:#FAFAFA;"><pre class="shiki shiki-themes one-dark-pro one-light vp-code"><code class="language-c"><span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">__prelude </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">static</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;"> void</span></span>
<span class="line"><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;">__init_pagetable</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">struct</span><span style="--shiki-dark:#E06C75;--shiki-light:#383A42;"> init_info</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">*</span><span style="--shiki-dark:#E06C75;--shiki-dark-font-style:italic;--shiki-light:#383A42;--shiki-light-font-style:inherit;"> init</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">)</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">{</span></span>
<span class="line"><span style="--shiki-dark:#56B6C2;--shiki-light:#0184BC;">  pde_t</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">*</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> pd </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">=</span><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;"> bootmem_alloc</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(ORDOS_KERNEL_PAGE_SIZE);</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">  size_t</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> pde_cnt </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">=</span></span>
<span class="line"><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;">    min</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;">div_up</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;">bootmem_end</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">() </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">/</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> ORDOS_KERNEL_PAGE_SIZE, VPAGE_DESC_CNT),</span></span>
<span class="line"><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;">        pde_index</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(MEM_TYPE_HIGH_START));</span></span>
<span class="line"><span style="--shiki-dark:#56B6C2;--shiki-light:#0184BC;">  pte_t</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">*</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> pt </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">=</span><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;"> bootmem_alloc</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(pde_cnt </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">*</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> ORDOS_KERNEL_PAGE_SIZE);</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">  size_t</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> pte_cnt </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">=</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> pde_cnt </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">*</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> VPAGE_DESC_CNT;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">  void*</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> pt_iter </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">=</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> pt;</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">  for</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> (</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">size_t</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> i </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">=</span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;"> 0</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">; i </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">&lt;</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> pde_cnt; </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">++</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">i) {</span></span>
<span class="line"><span style="--shiki-dark:#E06C75;--shiki-light:#E45649;">    pd</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">[i] </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">=</span><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;"> pde_desc</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(pt_iter, PG_PRESENT </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">|</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> PG_WRITABLE </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">|</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> PG_KERNEL);</span></span>
<span class="line"><span style="--shiki-dark:#E06C75;--shiki-light:#E45649;">    pd</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">[i </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">+</span><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;"> pde_index</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(ORDOS_KERNEL_VADDR)] </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">=</span><span style="--shiki-dark:#E06C75;--shiki-light:#E45649;"> pd</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">[i];</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">    pt_iter </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">=</span><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;"> poffset</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(pt_iter, ORDOS_KERNEL_PAGE_SIZE);</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">  for</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> (</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">size_t</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> i </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">=</span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;"> 0</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">; i </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">&lt;</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> pte_cnt; </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">++</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">i) {</span></span>
<span class="line"><span style="--shiki-dark:#E06C75;--shiki-light:#E45649;">    pt</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">[i] </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">=</span><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;"> pte_desc</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(i </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">*</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> ORDOS_KERNEL_PAGE_SIZE,</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">                     PG_PRESENT </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">|</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> PG_WRITABLE </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">|</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> PG_KERNEL);</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;">  vpage_load</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(pd);</span></span>
<span class="line"><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;">  vpage_enable</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#E5C07B;--shiki-light:#E45649;">  init</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">-&gt;</span><span style="--shiki-dark:#E06C75;--shiki-light:#E45649;">kernel_pd</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;"> =</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> pd;</span></span>
<span class="line"><span style="--shiki-dark:#E5C07B;--shiki-light:#E45649;">  init</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">-&gt;</span><span style="--shiki-dark:#E06C75;--shiki-light:#E45649;">kernel_pde_cnt</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;"> =</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> pde_cnt;</span></span>
<span class="line"><span style="--shiki-dark:#E5C07B;--shiki-light:#E45649;">  init</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">-&gt;</span><span style="--shiki-dark:#E06C75;--shiki-light:#E45649;">kernel_pt</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;"> =</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> pt;</span></span>
<span class="line"><span style="--shiki-dark:#E5C07B;--shiki-light:#E45649;">  init</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">-&gt;</span><span style="--shiki-dark:#E06C75;--shiki-light:#E45649;">kernel_pte_cnt</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;"> =</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> pte_cnt;</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>最后，我们加载 GDT ：</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-dark:#abb2bf;--shiki-light:#383A42;--shiki-dark-bg:#282c34;--shiki-light-bg:#FAFAFA;"><pre class="shiki shiki-themes one-dark-pro one-light vp-code"><code class="language-c"><span class="line"><span style="--shiki-dark:#56B6C2;--shiki-light:#0184BC;">gdtr_t</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> gdtr </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">=</span><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;"> gdt_create_ptr</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#E06C75;--shiki-light:#383A42;">__gdt</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">,</span><span style="--shiki-dark:#E06C75;--shiki-light:#383A42;"> ORDOS_MEM_GDT_DESC_CNT</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">);</span></span>
<span class="line"><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;">asm_exec</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#98C379;--shiki-light:#50A14F;">&quot;lgdt </span><span style="--shiki-dark:#FFFFFF;--shiki-light:white;">%</span><span style="--shiki-dark:#98C379;--shiki-light:#50A14F;">0&quot;</span><span style="--shiki-dark:#E06C75;--shiki-light:#383A42;"> : : </span><span style="--shiki-dark:#98C379;--shiki-light:#50A14F;">&quot;m&quot;</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#E06C75;--shiki-light:#383A42;">gdtr</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">));</span></span>
<span class="line"><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;">asm_exec</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#98C379;--shiki-light:#50A14F;">&quot;ljmp </span><span style="--shiki-dark:#FFFFFF;--shiki-light:white;">%</span><span style="--shiki-dark:#98C379;--shiki-light:#50A14F;">0, $1f;&quot;</span></span>
<span class="line"><span style="--shiki-dark:#98C379;--shiki-light:#50A14F;">         &quot;1:&quot;</span><span style="--shiki-dark:#E06C75;--shiki-light:#383A42;"> : : </span><span style="--shiki-dark:#98C379;--shiki-light:#50A14F;">&quot;i&quot;</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;">gdt_sel_kcode</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">()));</span></span>
<span class="line"><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;">asm_exec</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#98C379;--shiki-light:#50A14F;">&quot;movw </span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;">%%</span><span style="--shiki-dark:#98C379;--shiki-light:#50A14F;">ax, </span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;">%%</span><span style="--shiki-dark:#98C379;--shiki-light:#50A14F;">ds;&quot;</span></span>
<span class="line"><span style="--shiki-dark:#98C379;--shiki-light:#50A14F;">         &quot;movw </span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;">%%</span><span style="--shiki-dark:#98C379;--shiki-light:#50A14F;">ax, </span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;">%%</span><span style="--shiki-dark:#98C379;--shiki-light:#50A14F;">es;&quot;</span></span>
<span class="line"><span style="--shiki-dark:#98C379;--shiki-light:#50A14F;">         &quot;movw </span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;">%%</span><span style="--shiki-dark:#98C379;--shiki-light:#50A14F;">ax, </span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;">%%</span><span style="--shiki-dark:#98C379;--shiki-light:#50A14F;">fs;&quot;</span></span>
<span class="line"><span style="--shiki-dark:#98C379;--shiki-light:#50A14F;">         &quot;movw </span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;">%%</span><span style="--shiki-dark:#98C379;--shiki-light:#50A14F;">ax, </span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;">%%</span><span style="--shiki-dark:#98C379;--shiki-light:#50A14F;">gs;&quot;</span></span>
<span class="line"><span style="--shiki-dark:#98C379;--shiki-light:#50A14F;">         &quot;movw </span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;">%%</span><span style="--shiki-dark:#98C379;--shiki-light:#50A14F;">ax, </span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;">%%</span><span style="--shiki-dark:#98C379;--shiki-light:#50A14F;">ss;&quot;</span><span style="--shiki-dark:#E06C75;--shiki-light:#383A42;"> : : </span><span style="--shiki-dark:#98C379;--shiki-light:#50A14F;">&quot;a&quot;</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;">gdt_sel_kdata</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">()));</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="进入内核之前" tabindex="-1"><a class="header-anchor" href="#进入内核之前"><span>进入内核之前</span></a></h2><p>我们完成了 Prelude 之后，要进入内核还需要修改栈指针，因为我们很快就会移除低地址的映射：</p><div class="language-asm line-numbers-mode" data-highlighter="shiki" data-ext="asm" style="--shiki-dark:#abb2bf;--shiki-light:#383A42;--shiki-dark-bg:#282c34;--shiki-light-bg:#FAFAFA;"><pre class="shiki shiki-themes one-dark-pro one-light vp-code"><code class="language-asm"><span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">addl </span><span style="--shiki-dark:#E06C75;--shiki-light:#383A42;">$ORDOS_KERNEL_VADDR</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">, %</span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;">esp</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>最后，我们调用<code>kmain</code>：</p><div class="language-asm line-numbers-mode" data-highlighter="shiki" data-ext="asm" style="--shiki-dark:#abb2bf;--shiki-light:#383A42;--shiki-dark-bg:#282c34;--shiki-light-bg:#FAFAFA;"><pre class="shiki shiki-themes one-dark-pro one-light vp-code"><code class="language-asm"><span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#383A42;">call</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> kmain</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>至此，我们的内核初始化流程完整结束。</p><h2 id="项目链接" tabindex="-1"><a class="header-anchor" href="#项目链接"><span>项目链接</span></a></h2><p><a href="https://github.com/Dessera/OrdOS" target="_blank" rel="noopener noreferrer"><img src="https://github-readme-stats.vercel.app/api/pin/?username=Dessera&amp;repo=OrdOS" alt="OrdOS"></a></p>`,81)]))}const p=i(h,[["render",e]]),d=JSON.parse('{"path":"/article/d7qqxor8/","title":"项目笔记-OrdOS操作系统01-启动流程","lang":"zh-CN","frontmatter":{"title":"项目笔记-OrdOS操作系统01-启动流程","createTime":"2025/08/14 16:08:21","permalink":"/article/d7qqxor8/","tags":["OS","C","ASM","Multiboot2"],"description":"笔者在重写自己的操作系统内核，在这个过程中，我发现通过MBR + Loader + Kernel的三段式启动非常不方便，而且完全不好移植，因此，笔者前去了解了一下现代操作系统的启动流程。 注意，本文代码部分进行了一定的简化，省略了错误处理和参数检查流程，详细请参考OrdOS，截至本文完成，所有的代码均托管于ordos/v2分支。 Loader 我们都知...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"项目笔记-OrdOS操作系统01-启动流程\\",\\"image\\":[\\"https://github-readme-stats.vercel.app/api/pin/?username=Dessera&repo=OrdOS\\"],\\"dateModified\\":\\"2025-10-08T11:03:23.000Z\\",\\"author\\":[]}"],["meta",{"property":"og:url","content":"https://dessera.github.io/article/d7qqxor8/"}],["meta",{"property":"og:site_name","content":"Dessera Lab"}],["meta",{"property":"og:title","content":"项目笔记-OrdOS操作系统01-启动流程"}],["meta",{"property":"og:description","content":"笔者在重写自己的操作系统内核，在这个过程中，我发现通过MBR + Loader + Kernel的三段式启动非常不方便，而且完全不好移植，因此，笔者前去了解了一下现代操作系统的启动流程。 注意，本文代码部分进行了一定的简化，省略了错误处理和参数检查流程，详细请参考OrdOS，截至本文完成，所有的代码均托管于ordos/v2分支。 Loader 我们都知..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://github-readme-stats.vercel.app/api/pin/?username=Dessera&repo=OrdOS"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-10-08T11:03:23.000Z"}],["meta",{"property":"article:tag","content":"Multiboot2"}],["meta",{"property":"article:tag","content":"ASM"}],["meta",{"property":"article:tag","content":"C"}],["meta",{"property":"article:tag","content":"OS"}],["meta",{"property":"article:modified_time","content":"2025-10-08T11:03:23.000Z"}]]},"readingTime":{"minutes":7.69,"words":2306},"git":{"createdTime":1757139174000,"updatedTime":1759921403000,"contributors":[{"name":"Dessera","username":"Dessera","email":"dessera@qq.com","commits":2,"avatar":"https://avatars.githubusercontent.com/Dessera?v=4","url":"https://github.com/Dessera"}],"changelog":[{"hash":"8822e76d8d2b38cdc55efc7d8980256c70213d4a","time":1759921403000,"email":"dessera@qq.com","author":"Dessera","message":"MNN01"},{"hash":"86e9c16f7deb86869111def5deeb9f6e5f3a1096","time":1757139174000,"email":"dessera@qq.com","author":"Dessera","message":"项目笔记-OrdOS操作系统01-启动流程"}]},"autoDesc":true,"filePathRelative":"笔记/项目笔记-OrdOS操作系统01-启动流程.md","headers":[],"categoryList":[{"id":"7051dc","sort":10000,"name":"笔记"}]}');export{p as comp,d as data};
